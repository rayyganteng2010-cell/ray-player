<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ray Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    :root { --sp-green:#1DB954; }
    body{ background:#000; color:#fff; font-family:'Plus Jakarta Sans',sans-serif; overflow:hidden; }
    #sidebar{ width:280px; transition:.25s; background:#000; border-right:1px solid #222; }
    #sidebar.hidden-mode{ width:0; padding:0; opacity:0; pointer-events:none; transform:translateX(-20px); }

    .search-input{ background:#242424!important; color:#fff!important; border:1px solid transparent; }
    .search-input::placeholder{ color:#888; }
    .search-input:focus{ background:#2a2a2a!important; border-color:#555; }

    #toast{
      position:fixed; top:18px; left:50%; transform:translate(-50%,-160%);
      background:var(--sp-green); color:#000; padding:12px 16px;
      border-radius:999px; font-weight:800; transition:.25s; z-index:9999;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      max-width:min(92vw,720px); text-align:center;
    }
    #toast.active{ transform:translate(-50%,0); }

    main{ padding-bottom:190px!important; }

    .music-card{
      background:#181818; border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:14px; cursor:pointer; transition:.2s;
      position: relative;
    }
    .music-card:hover{ background:#242424; transform:translateY(-4px); }

    .card-plus{
      position:absolute; top:10px; right:10px;
      width:34px; height:34px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      transition:.15s;
      z-index: 5;
    }
    .card-plus:hover{ transform:scale(1.06); background: rgba(0,0,0,.70); }

    /* Player bar */
    #playerBar{
      position:fixed; left:12px; right:12px; bottom:12px;
      height:110px; padding:12px 14px;
      background:rgba(18,18,18,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      box-shadow:0 24px 70px rgba(0,0,0,.55);
      display:none; align-items:center; gap:12px; z-index:1000;
    }
    #playerBar.active{ display:flex; }

    .song-info{ flex:1; min-width:0; display:flex; align-items:center; gap:12px; cursor:pointer; }
    .controls{ flex:2; min-width:0; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .rightzone{ flex:1; min-width:0; display:flex; justify-content:flex-end; align-items:center; gap:10px; }

    .icon-btn{ color:#9ca3af; transition:.15s; }
    .icon-btn:hover{ color:#fff; transform:translateY(-1px); }

    #playBtn{
      width:44px; height:44px; border-radius:999px;
      background:#fff; color:#000;
      display:flex; align-items:center; justify-content:center;
      transition:.15s; box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    #playBtn:hover{ transform:scale(1.08); }

    .progress-bg{
      width:100%; max-width:560px; height:6px;
      background:rgba(255,255,255,.12);
      border-radius:999px; overflow:hidden; cursor:pointer;
    }
    #progressFill{ height:100%; width:0%; background:var(--sp-green); border-radius:999px; }

    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      transition:.15s;
    }
    .pill:hover{ background: rgba(255,255,255,.10); }

    /* Marquee title */
    .marquee {
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      mask-image: linear-gradient(to right, transparent, black 12%, black 88%, transparent);
      -webkit-mask-image: linear-gradient(to right, transparent, black 12%, black 88%, transparent);
    }
    .marquee > .marquee-inner{
      display: inline-block;
      padding-left: 0;
      animation: marquee 10s linear infinite;
    }
    .marquee.paused > .marquee-inner { animation-play-state: paused; }
    @keyframes marquee{ 0%{transform:translateX(0%)} 100%{transform:translateX(-50%)} }

    /* Modal base */
    .modal{
      position: fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:flex-end; justify-content:center;
      z-index:2500;
      padding: 18px;
    }
    .modal.active{ display:flex; }

    .modalCard{
      width: min(720px, 100%);
      background: rgba(18,18,18,.95);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow: hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalBody{ padding: 16px; display:grid; gap:14px; }

    /* Now Playing modal */
    .npCover{
      width: 100%; aspect-ratio: 1/1;
      background:#0b0b0b; border-radius: 18px; overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .npCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .npTitle{ font-weight: 900; font-size: 18px; line-height: 1.15; }
    .npArtist{ color:#a1a1aa; font-size: 13px; margin-top: 6px; }
    .npControls{ display:flex; align-items:center; justify-content:center; gap:18px; padding-top: 6px; }
    .npBigPlay{
      width: 64px; height: 64px; border-radius: 999px;
      background:#fff; color:#000;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      transition: .15s;
    }
    .npBigPlay:hover{ transform: scale(1.06); }

    /* Playlist cards */
    .plCard{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      overflow:hidden;
      transition:.18s;
      cursor:pointer;
    }
    .plCard:hover{ background: rgba(255,255,255,.07); transform: translateY(-3px); }
    .plCover{
      width:100%; aspect-ratio: 1/1;
      background: #0b0b0b;
      overflow:hidden;
    }
    .plCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .plMeta{ padding: 12px; }
    .plName{ font-weight: 900; font-size: 14px; }
    .plSub{ color:#a1a1aa; font-size: 11px; margin-top: 4px; }

    /* Playlist detail header */
    .hero{
      display:flex; gap:16px; align-items:flex-end;
      padding: 10px 0 18px 0;
    }
    .heroImg{
      width: 160px; height: 160px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background:#0b0b0b;
      flex: none;
    }
    .heroImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .heroTitle{ font-size: 34px; font-weight: 950; line-height:1.05; }
    .heroSub{ color:#a1a1aa; font-size: 12px; margin-top: 10px; }
    .heroActions{ display:flex; gap:10px; margin-top: 14px; flex-wrap: wrap; }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      transition:.15s;
      font-weight: 900;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .btnPrimary{ background: var(--sp-green); color:#000; border-color: rgba(29,185,84,.55); }
    .btnPrimary:hover{ background: #22c55e; }

    /* song list row */
    .row{
      display:flex; align-items:center; gap:12px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      transition:.15s;
      cursor:pointer;
    }
    .row:hover{ background: rgba(255,255,255,.06); }
    .rowImg{ width:44px; height:44px; border-radius: 12px; overflow:hidden; background:#0b0b0b; border:1px solid rgba(255,255,255,.08); }
    .rowImg img{ width:100%; height:100%; object-fit:cover; }
    .rowMain{ flex:1; min-width:0; }
    .rowTitle{ font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rowSub{ color:#a1a1aa; font-size: 11px; margin-top: 3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rowRight{ display:flex; align-items:center; gap:10px; color:#9ca3af; }
    .rowRight button{ padding:8px; border-radius: 999px; }
    .rowRight button:hover{ background: rgba(255,255,255,.08); color:#fff; }

    /* hide iframe */
    #ytWrap{ position:fixed; width:1px; height:1px; left:-9999px; top:-9999px; overflow:hidden; }

    @media (max-width:768px){
      #sidebar{ position:absolute; height:100%; z-index:2100; }
      #playerBar{ left:10px; right:10px; bottom:10px; height:118px; padding:12px; }
      .rightzone{ display:none; }
      .controls{ flex:3; }
      .hero{ flex-direction: column; align-items:flex-start; }
      .heroImg{ width: 100%; height: auto; aspect-ratio: 1/1; }
      .heroTitle{ font-size: 26px; }
    }
  </style>
</head>

<body class="flex">
  <div id="toast">Ray Player siap.</div>

  <!-- Sidebar -->
  <aside id="sidebar" class="flex flex-col h-screen p-5 shrink-0">
    <div class="flex items-center gap-3 mb-10 cursor-pointer" onclick="toggleSidebar()">
      <i class="fab fa-spotify text-3xl text-green-500"></i>
      <span class="text-xl font-extrabold tracking-tighter">RayPlayer</span>
    </div>

    <nav class="space-y-2">
      <button id="navHome" class="w-full flex items-center gap-4 text-gray-400 hover:text-white transition font-extrabold cursor-pointer px-3 py-2 rounded-xl hover:bg-white/5"
              onclick="goHome()">
        <i class="fas fa-house text-xl"></i> Home
      </button>

      <button id="navSearch" class="w-full flex items-center gap-4 text-gray-400 hover:text-white transition font-extrabold cursor-pointer px-3 py-2 rounded-xl hover:bg-white/5"
              onclick="goSearch()">
        <i class="fas fa-search text-xl"></i> Search
      </button>

      <button id="navPlaylists" class="w-full flex items-center gap-4 text-gray-400 hover:text-white transition font-extrabold cursor-pointer px-3 py-2 rounded-xl hover:bg-white/5"
              onclick="goPlaylists()">
        <i class="fas fa-music text-xl"></i> Playlist
      </button>
    </nav>

    <div class="mt-8 overflow-hidden">
      <div class="flex items-center justify-between mb-3">
        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Your Playlists</p>
        <button class="p-2 rounded-full hover:bg-white/10 transition" onclick="openCreatePlaylist()" title="Create Playlist">
          <i class="fas fa-plus text-xs text-gray-300"></i>
        </button>
      </div>
      <div id="sidebarPlList" class="space-y-2 overflow-y-auto max-h-[52vh] pr-1"></div>
      <div id="sidebarPlEmpty" class="text-xs text-gray-600 mt-2 hidden">Belum ada playlist. Klik + buat bikin.</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 h-screen overflow-y-auto bg-gradient-to-b from-[#1e1e1e] to-black p-5 lg:p-10">
    <!-- Top bar -->
    <header class="flex items-center gap-4 mb-10">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-full transition">
        <i class="fas fa-bars"></i>
      </button>

      <div class="flex-1 max-w-xl relative" id="searchBoxWrap">
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Cari lagu apa hari ini?"
               class="search-input w-full py-3 pl-12 pr-4 rounded-full outline-none" />
      </div>

      <button id="searchBtn" onclick="searchMusic()" class="bg-white text-black px-6 py-3 rounded-full font-extrabold hover:scale-105 transition">
        Search
      </button>
    </header>

    <!-- HOME view -->
    <section id="viewHome">
      <div class="flex items-end justify-between mb-6">
        <h2 class="text-3xl font-extrabold">RayPlayer</h2>
        <div class="text-xs text-gray-400">Home</div>
      </div>
      <div class="p-6 rounded-2xl border border-white/10 bg-white/5">
        <div class="text-lg font-extrabold">Tips</div>
        <ul class="text-sm text-gray-300 mt-3 space-y-2 list-disc pl-5">
          <li>Pakai menu <b>Playlist</b> buat bikin playlist, pasang cover, dan mainkan lagu berurutan/acak.</li>
          <li>Di menu <b>Search</b>, klik (+) buat tambah lagu ke playlist pilihanmu.</li>
          <li>Klik mini player di bawah buat buka Now Playing.</li>
        </ul>
      </div>
    </section>

    <!-- SEARCH view -->
    <section id="viewSearch" class="hidden">
      <div class="flex items-end justify-between mb-6">
        <h2 class="text-2xl font-extrabold">Search</h2>
        <div class="text-xs text-gray-400">Klik kartu buat play • klik (+) buat tambah ke playlist</div>
      </div>
      <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
    </section>

    <!-- PLAYLIST LIST view -->
    <section id="viewPlaylists" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-extrabold">Koleksi Kamu</h2>
        <button class="btn" onclick="openCreatePlaylist()"><i class="fas fa-plus"></i> Buat Playlist</button>
      </div>
      <div id="plGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
      <div id="plGridEmpty" class="hidden text-gray-400 text-sm py-20 text-center">
        Belum ada playlist. Klik <b>Buat Playlist</b> untuk mulai.
      </div>
    </section>

    <!-- PLAYLIST DETAIL view -->
    <section id="viewPlaylistDetail" class="hidden">
      <div class="flex items-center gap-3 mb-3">
        <button class="p-2 rounded-full hover:bg-white/10 transition" onclick="goPlaylists()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="text-xs text-gray-400">Playlist</div>
      </div>

      <div class="hero">
        <div class="heroImg">
          <img id="dCover" src="" alt="cover">
        </div>
        <div class="min-w-0">
          <div id="dName" class="heroTitle">Playlist</div>
          <div id="dMeta" class="heroSub">0 lagu • Rayy</div>

          <div class="heroActions">
            <button class="btn btnPrimary" onclick="playDetailStart(false)"><i class="fas fa-play"></i> Play</button>
            <button class="btn" onclick="playDetailStart(true)"><i class="fas fa-shuffle"></i> Shuffle</button>
            <button class="btn" onclick="cycleRepeatMode()"><i id="repIcon" class="fas fa-repeat"></i> Repeat</button>
            <button class="btn" onclick="toggleShuffle()"><i id="shufIcon" class="fas fa-shuffle"></i> Shuffle Mode</button>
            <button class="btn" onclick="openEditPlaylist()"><i class="fas fa-pen"></i> Edit</button>
            <button class="btn" onclick="deleteCurrentPlaylist()"><i class="fas fa-trash"></i> Hapus</button>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <div class="text-xs text-gray-400 mb-3">Daftar lagu</div>
        <div id="dSongs" class="space-y-2"></div>
        <div id="dEmpty" class="hidden text-gray-500 text-sm py-16 text-center">
          Playlist kosong. Cari lagu di Search lalu tambah ke playlist ini.
        </div>
      </div>
    </section>
  </main>

  <!-- Mini Player -->
  <footer id="playerBar">
    <div class="song-info" onclick="openNowPlaying()">
      <img id="pImg" src="" class="w-14 h-14 rounded-xl object-cover shadow-lg border border-white/5" />
      <div class="min-w-0 w-full">
        <div id="pTitleWrap" class="marquee paused">
          <div id="pTitleInner" class="marquee-inner">
            <span id="pTitle" class="text-sm font-extrabold">Pilih Lagu</span>
            <span class="mx-6 opacity-50">•</span>
            <span id="pTitleDup" class="text-sm font-extrabold">Pilih Lagu</span>
          </div>
        </div>
        <div class="flex items-center gap-2 mt-1">
          <div id="pArtist" class="text-xs text-gray-400 truncate"></div>
          <span id="pDur" class="text-[10px] text-gray-500 font-mono"></span>
        </div>
      </div>
    </div>

    <div class="controls" onclick="event.stopPropagation()">
      <div class="flex items-center gap-6">
        <button onclick="prev()" class="icon-btn" title="Prev"><i class="fas fa-step-backward text-xl"></i></button>

        <button id="playBtn" onclick="togglePlay()" title="Play/Pause">
          <i class="fas fa-play ml-0.5"></i>
        </button>

        <button onclick="next()" class="icon-btn" title="Next"><i class="fas fa-step-forward text-xl"></i></button>

        <button onclick="cycleRepeatMode()" class="icon-btn" title="Repeat">
          <i id="miniRepIcon" class="fas fa-repeat"></i>
        </button>

        <button onclick="toggleShuffle()" class="icon-btn" title="Shuffle">
          <i id="miniShufIcon" class="fas fa-shuffle"></i>
        </button>
      </div>

      <div class="flex items-center w-full gap-3">
        <span id="curT" class="text-[10px] text-gray-400 w-10 text-right font-mono">0:00</span>
        <div class="progress-bg flex-1" onclick="seek(event)">
          <div id="progressFill"></div>
        </div>
        <span id="durT" class="text-[10px] text-gray-400 w-10 font-mono">0:00</span>
      </div>
    </div>

    <div class="rightzone" onclick="event.stopPropagation()">
      <a id="openYT" class="pill text-xs text-gray-200" href="#" target="_blank" rel="noreferrer" title="Open on YouTube">
        <i class="fab fa-youtube text-red-500"></i><span>Open</span>
      </a>

      <div class="pill">
        <i class="fas fa-volume-up text-gray-300"></i>
        <input id="vol" type="range" min="0" max="100" step="1" value="100"
               class="w-24 accent-green-500 cursor-pointer" />
      </div>
    </div>
  </footer>

  <!-- Now Playing Modal -->
  <div id="npModal" class="modal" onclick="closeNowPlaying()">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="text-sm font-extrabold text-white/90">Now Playing</div>
        <button class="p-2 rounded-full hover:bg-white/10 transition" onclick="closeNowPlaying()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>

      <div class="modalBody">
        <div class="npCover"><img id="npImg" src="" alt="cover"></div>
        <div>
          <div id="npTitle" class="npTitle">Pilih Lagu</div>
          <div id="npArtist" class="npArtist">YouTube</div>
          <div id="npSource" class="text-[11px] text-gray-500 mt-2"></div>
        </div>

        <div class="flex items-center w-full gap-3">
          <span id="npCur" class="text-[11px] text-gray-400 w-12 text-right font-mono">0:00</span>
          <div class="progress-bg flex-1" onclick="npSeek(event)">
            <div id="npProgressFill" style="height:100%; width:0%; background:var(--sp-green); border-radius:999px;"></div>
          </div>
          <span id="npDur" class="text-[11px] text-gray-400 w-12 font-mono">0:00</span>
        </div>

        <div class="npControls">
          <button onclick="toggleShuffle()" class="icon-btn" title="Shuffle"><i class="fas fa-shuffle"></i></button>
          <button onclick="prev()" class="icon-btn" title="Prev"><i class="fas fa-backward-step text-xl"></i></button>

          <button class="npBigPlay" onclick="togglePlay()" title="Play/Pause">
            <i id="npPlayIcon" class="fas fa-play ml-0.5"></i>
          </button>

          <button onclick="next()" class="icon-btn" title="Next"><i class="fas fa-forward-step text-xl"></i></button>
          <button onclick="cycleRepeatMode()" class="icon-btn" title="Repeat"><i id="npRepIcon" class="fas fa-repeat"></i></button>
        </div>

        <div class="flex items-center justify-between gap-3">
          <a id="npOpenYT" class="pill text-xs text-gray-200" href="#" target="_blank" rel="noreferrer">
            <i class="fab fa-youtube text-red-500"></i><span>Open on YouTube</span>
          </a>

          <div class="pill">
            <i class="fas fa-volume-high text-gray-300"></i>
            <input id="npVol" type="range" min="0" max="100" step="1" value="100"
                   class="w-32 accent-green-500 cursor-pointer" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Playlist Modal -->
  <div id="addModal" class="modal" onclick="closeAddModal()">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="text-sm font-extrabold text-white/90">Tambah ke Playlist</div>
        <button class="p-2 rounded-full hover:bg-white/10 transition" onclick="closeAddModal()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="modalBody">
        <div class="text-sm font-extrabold" id="addSongTitle">Lagu</div>
        <div class="text-xs text-gray-400 -mt-2" id="addSongSub"></div>

        <div class="space-y-2" id="addPlChoices"></div>

        <button class="btn" onclick="openCreatePlaylist(true)"><i class="fas fa-plus"></i> Buat playlist baru</button>
      </div>
    </div>
  </div>

  <!-- Create/Edit Playlist Modal -->
  <div id="plModal" class="modal" onclick="closePlModal()">
    <div class="modalCard" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="text-sm font-extrabold text-white/90" id="plModalTitle">Buat Playlist</div>
        <button class="p-2 rounded-full hover:bg-white/10 transition" onclick="closePlModal()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="modalBody">
        <label class="text-xs text-gray-400">Nama playlist</label>
        <input id="plNameInput" class="search-input w-full py-3 px-4 rounded-xl outline-none" placeholder="Contoh: GALAU BANGETT" />

        <label class="text-xs text-gray-400 mt-2">Cover playlist (upload gambar)</label>
        <input id="plCoverInput" type="file" accept="image/*" class="text-xs text-gray-300" />

        <div class="flex items-center gap-12">
          <div class="w-28 h-28 rounded-2xl overflow-hidden border border-white/10 bg-black/40">
            <img id="plCoverPreview" src="" alt="cover" class="w-full h-full object-cover">
          </div>
          <div class="text-xs text-gray-400">
            Cover bisa diubah kapan aja.<br/>
            Disimpan di localStorage.
          </div>
        </div>

        <button id="plSaveBtn" class="btn btnPrimary justify-center" onclick="savePlaylistMeta()">
          <i class="fas fa-check"></i> Simpan
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden YouTube player -->
  <div id="ytWrap"><div id="ytPlayer"></div></div>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // -------- Data model --------
    // playlists: [{ id, name, coverDataUrl, createdAt, songs: [track...] }]
    // track: {id,url,title,thumb,author,duration}

    const LS_PLAYLISTS = "ray_playlists_v1";
    const LS_MODES = "ray_modes_v1";

    let results = [];
    let playlists = [];
    let currentPlaylistId = null;

    // playback context
    // source: { type: 'playlist', playlistId } OR { type: 'results' }
    let playContext = { type: 'playlist', playlistId: null };
    let nowTrack = null;
    let player = null;
    let progressTimer = null;

    // modes
    // repeatMode: 0 off, 1 all, 2 one
    let repeatMode = 1;
    let shuffleOn = false;

    // state for modals
    let addPendingTrack = null;
    let editingPlaylistId = null;
    let createFromAddFlow = false;

    // -------- UI helpers --------
    function showNotif(msg){
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.add('active');
      setTimeout(() => t.classList.remove('active'), 2200);
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function toggleSidebar(){
      document.getElementById('sidebar').classList.toggle('hidden-mode');
    }

    function setActiveNav(id){
      const ids = ["navHome","navSearch","navPlaylists"];
      ids.forEach(x=>{
        const el = document.getElementById(x);
        el.classList.remove("bg-white/10","text-white");
        el.classList.add("text-gray-400");
      });
      const a = document.getElementById(id);
      a.classList.add("bg-white/10","text-white");
      a.classList.remove("text-gray-400");
    }

    function showView(viewId){
      ["viewHome","viewSearch","viewPlaylists","viewPlaylistDetail"].forEach(id=>{
        document.getElementById(id).classList.toggle("hidden", id !== viewId);
      });

      // search box only meaningful for Search
      const showSearchUI = (viewId === "viewSearch");
      document.getElementById("searchBoxWrap").classList.toggle("hidden", !showSearchUI);
      document.getElementById("searchBtn").classList.toggle("hidden", !showSearchUI);
    }

    // -------- Navigation --------
    function goHome(){
      setActiveNav("navHome");
      showView("viewHome");
    }
    function goSearch(){
      setActiveNav("navSearch");
      showView("viewSearch");
      setTimeout(()=>document.getElementById("searchInput").focus(), 80);
    }
    function goPlaylists(){
      setActiveNav("navPlaylists");
      showView("viewPlaylists");
      renderPlaylistsGrid();
    }

    // -------- Storage --------
    function saveAll(){
      localStorage.setItem(LS_PLAYLISTS, JSON.stringify(playlists));
      localStorage.setItem(LS_MODES, JSON.stringify({ repeatMode, shuffleOn }));
      renderSidebarPlaylists();
      renderPlaylistsGrid();
    }

    function loadAll(){
      try{ playlists = JSON.parse(localStorage.getItem(LS_PLAYLISTS) || "[]") || []; }catch{ playlists=[]; }
      try{
        const m = JSON.parse(localStorage.getItem(LS_MODES) || "{}") || {};
        repeatMode = typeof m.repeatMode === "number" ? m.repeatMode : 1;
        shuffleOn = !!m.shuffleOn;
      }catch{}
    }

    function getPlaylist(pid){
      return playlists.find(p=>p.id===pid) || null;
    }

    // -------- Playlist UI (sidebar + grid + detail) --------
    function renderSidebarPlaylists(){
      const box = document.getElementById("sidebarPlList");
      const empty = document.getElementById("sidebarPlEmpty");
      empty.classList.toggle("hidden", playlists.length !== 0);

      box.innerHTML = playlists.map(p => `
        <button class="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/5 transition
                       ${p.id===currentPlaylistId ? 'bg-white/10' : ''}"
                onclick="openPlaylistDetail('${p.id}')">
          <div class="w-10 h-10 rounded-xl overflow-hidden border border-white/10 bg-black/40 flex-none">
            <img src="${p.coverDataUrl || defaultCover()}" class="w-full h-full object-cover" />
          </div>
          <div class="min-w-0 text-left">
            <div class="text-xs font-extrabold truncate">${escapeHtml(p.name)}</div>
            <div class="text-[10px] text-gray-500 truncate">${p.songs?.length || 0} lagu</div>
          </div>
        </button>
      `).join('');
    }

    function defaultCover(){
      // simple placeholder gradient (data URI svg)
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="600">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#1e1e1e"/>
              <stop offset="1" stop-color="#000000"/>
            </linearGradient>
          </defs>
          <rect width="600" height="600" fill="url(#g)"/>
          <circle cx="300" cy="300" r="170" fill="rgba(255,255,255,0.06)"/>
          <text x="300" y="322" text-anchor="middle" font-family="Arial" font-size="54" fill="rgba(255,255,255,0.28)">Ray</text>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    function renderPlaylistsGrid(){
      const grid = document.getElementById("plGrid");
      const empty = document.getElementById("plGridEmpty");
      empty.classList.toggle("hidden", playlists.length !== 0);

      grid.innerHTML = playlists.map(p => `
        <div class="plCard" onclick="openPlaylistDetail('${p.id}')">
          <div class="plCover">
            <img src="${p.coverDataUrl || defaultCover()}" />
          </div>
          <div class="plMeta">
            <div class="plName truncate">${escapeHtml(p.name)}</div>
            <div class="plSub">${p.songs?.length || 0} lagu • Rayy</div>
          </div>
        </div>
      `).join('');
    }

    function openPlaylistDetail(pid){
      const p = getPlaylist(pid);
      if (!p) return showNotif("Playlist tidak ditemukan.");

      currentPlaylistId = pid;
      setActiveNav("navPlaylists");
      showView("viewPlaylistDetail");

      // header
      document.getElementById("dCover").src = p.coverDataUrl || defaultCover();
      document.getElementById("dName").innerText = p.name;
      document.getElementById("dMeta").innerText = `${p.songs.length} lagu • Rayy`;

      // song list
      renderPlaylistSongs(p);

      renderSidebarPlaylists();
      syncModeIcons();
    }

    function renderPlaylistSongs(p){
      const list = document.getElementById("dSongs");
      const empty = document.getElementById("dEmpty");
      empty.classList.toggle("hidden", p.songs.length !== 0);

      list.innerHTML = p.songs.map((t, idx) => `
        <div class="row" onclick="playFromPlaylist('${p.id}', ${idx})">
          <div class="rowImg"><img src="${t.thumb}" /></div>
          <div class="rowMain">
            <div class="rowTitle">${escapeHtml(t.title)}</div>
            <div class="rowSub">${escapeHtml(t.author)} • ${escapeHtml(t.duration || '')}</div>
          </div>
          <div class="rowRight" onclick="event.stopPropagation()">
            <span class="text-[11px] font-mono">${escapeHtml(t.duration || '')}</span>
            <button title="Hapus dari playlist" onclick="removeSongFromPlaylist('${p.id}', ${idx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function removeSongFromPlaylist(pid, idx){
      const p = getPlaylist(pid);
      if (!p) return;
      const removed = p.songs.splice(idx,1);
      saveAll();
      if (currentPlaylistId === pid) openPlaylistDetail(pid);
      showNotif(`Hapus: ${removed[0]?.title || ''}`);
    }

    function deleteCurrentPlaylist(){
      if (!currentPlaylistId) return;
      const p = getPlaylist(currentPlaylistId);
      if (!p) return;
      playlists = playlists.filter(x => x.id !== currentPlaylistId);
      currentPlaylistId = null;
      saveAll();
      goPlaylists();
      showNotif("Playlist dihapus.");
    }

    // -------- Create/Edit playlist --------
    function openCreatePlaylist(fromAdd=false){
      createFromAddFlow = !!fromAdd;
      editingPlaylistId = null;
      document.getElementById("plModalTitle").innerText = "Buat Playlist";
      document.getElementById("plNameInput").value = "";
      document.getElementById("plCoverInput").value = "";
      document.getElementById("plCoverPreview").src = defaultCover();
      document.getElementById("plModal").classList.add("active");
    }

    function openEditPlaylist(){
      if (!currentPlaylistId) return;
      const p = getPlaylist(currentPlaylistId);
      if (!p) return;
      editingPlaylistId = p.id;
      createFromAddFlow = false;
      document.getElementById("plModalTitle").innerText = "Edit Playlist";
      document.getElementById("plNameInput").value = p.name;
      document.getElementById("plCoverInput").value = "";
      document.getElementById("plCoverPreview").src = p.coverDataUrl || defaultCover();
      document.getElementById("plModal").classList.add("active");
    }

    document.addEventListener("change", (e) => {
      if (e.target?.id === "plCoverInput"){
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => { document.getElementById("plCoverPreview").src = reader.result; };
        reader.readAsDataURL(file);
      }
    });

    function closePlModal(){
      document.getElementById("plModal").classList.remove("active");
    }

    function savePlaylistMeta(){
      const name = document.getElementById("plNameInput").value.trim();
      if (!name) return showNotif("Nama playlist wajib diisi.");

      const cover = document.getElementById("plCoverPreview").src || defaultCover();

      if (editingPlaylistId){
        const p = getPlaylist(editingPlaylistId);
        if (!p) return;
        p.name = name;
        p.coverDataUrl = cover;
        saveAll();
        closePlModal();
        openPlaylistDetail(p.id);
        showNotif("Playlist diupdate.");
        return;
      }

      const id = "pl_" + Math.random().toString(36).slice(2,10);
      playlists.unshift({
        id,
        name,
        coverDataUrl: cover,
        createdAt: Date.now(),
        songs: []
      });
      saveAll();
      closePlModal();
      showNotif("Playlist dibuat ✅");

      // if created from add flow, go back to add modal list
      if (createFromAddFlow){
        openAddModal(addPendingTrack);
      } else {
        goPlaylists();
      }
    }

    // -------- Add song to playlist flow --------
    function openAddModal(track){
      if (!track) return;
      addPendingTrack = track;

      document.getElementById("addSongTitle").innerText = track.title || "Lagu";
      document.getElementById("addSongSub").innerText = `${track.author || 'YouTube'} • ${track.duration || ''}`;

      const box = document.getElementById("addPlChoices");
      if (!playlists.length){
        box.innerHTML = `<div class="text-sm text-gray-400">Belum ada playlist. Buat dulu ya.</div>`;
      } else {
        box.innerHTML = playlists.map(p => {
          const exists = p.songs.some(s=>s.id===track.id);
          return `
            <button class="row" onclick="addTrackToPlaylist('${p.id}')">
              <div class="rowImg"><img src="${p.coverDataUrl || defaultCover()}" /></div>
              <div class="rowMain">
                <div class="rowTitle">${escapeHtml(p.name)}</div>
                <div class="rowSub">${p.songs.length} lagu</div>
              </div>
              <div class="rowRight">
                <span class="text-[11px] ${exists ? 'text-green-500' : 'text-gray-400'}">
                  ${exists ? 'Sudah ada' : 'Tambah'}
                </span>
                <i class="fas ${exists ? 'fa-check' : 'fa-plus'}"></i>
              </div>
            </button>
          `;
        }).join('');
      }

      document.getElementById("addModal").classList.add("active");
    }

    function closeAddModal(){
      document.getElementById("addModal").classList.remove("active");
    }

    function addTrackToPlaylist(pid){
      const p = getPlaylist(pid);
      if (!p || !addPendingTrack) return;

      const exists = p.songs.some(s=>s.id===addPendingTrack.id);
      if (exists){
        showNotif("Lagu sudah ada di playlist.");
        return;
      }
      p.songs.push(addPendingTrack);
      saveAll();
      showNotif("Ditambahkan ✅");

      // refresh add list state
      openAddModal(addPendingTrack);

      // if currently viewing that playlist, refresh it
      if (currentPlaylistId === pid && !document.getElementById("viewPlaylistDetail").classList.contains("hidden")){
        openPlaylistDetail(pid);
      }
    }

    // -------- Search view --------
    async function searchMusic(){
      const q = document.getElementById('searchInput').value.trim();
      if(!q) return showNotif("Tulis judul lagu dulu!");

      const grid = document.getElementById('grid');
      grid.innerHTML = `<div class="col-span-full text-center py-20">
        <i class="fas fa-spinner fa-spin text-4xl text-green-500"></i>
      </div>`;

      try{
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        results = data;
        renderResults();
      }catch(e){
        console.error(e);
        showNotif("Gagal mencari lagu.");
      }
    }

    function renderResults(){
      const grid = document.getElementById('grid');
      if(!results.length){
        grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400">Tidak ada hasil.</div>`;
        return;
      }

      grid.innerHTML = results.map((t, i) => `
        <div class="music-card group" onclick="playFromResults(${i})">
          <button class="card-plus" title="Tambah ke Playlist"
                  onclick="event.stopPropagation(); openAddModal(results[${i}]);">
            <i class="fas fa-plus"></i>
          </button>

          <div class="relative mb-3">
            <img src="${t.thumb}" class="w-full aspect-square object-cover rounded-xl shadow-lg">
            <div class="absolute inset-0 bg-black/45 opacity-0 group-hover:opacity-100 transition flex items-center justify-center rounded-xl">
              <div class="w-11 h-11 bg-green-500 rounded-full flex items-center justify-center shadow-xl">
                <i class="fas fa-play text-black"></i>
              </div>
            </div>
          </div>
          <div class="font-extrabold truncate text-sm">${escapeHtml(t.title)}</div>
          <div class="flex items-center justify-between gap-2 mt-1">
            <div class="text-xs text-gray-400 truncate">${escapeHtml(t.author)}</div>
            <div class="text-[10px] text-gray-500 font-mono">${escapeHtml(t.duration || "")}</div>
          </div>
        </div>
      `).join('');
    }

    // -------- Playback (playlist + results) --------
    function onYouTubeIframeAPIReady(){
      player = new YT.Player('ytPlayer', {
        height: '1',
        width: '1',
        videoId: '',
        playerVars: { autoplay: 0, controls: 0, rel: 0, modestbranding: 1, playsinline: 1 },
        events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
      });
    }

    function onPlayerReady(){
      loadAll();
      renderSidebarPlaylists();
      syncModeIcons();
      goHome();

      // volume
      document.getElementById('vol').addEventListener('input', (e) => player?.setVolume(Number(e.target.value)));
      document.getElementById('npVol').addEventListener('input', (e) => {
        const v = Number(e.target.value);
        player?.setVolume(v);
        document.getElementById('vol').value = String(v);
      });

      showNotif("Player siap.");
    }

    function onPlayerStateChange(e){
      if (e.data === YT.PlayerState.PLAYING){
        updatePlayIcons(true);
        startProgress();
        setMediaSessionPlaybackState('playing');
      } else if (e.data === YT.PlayerState.PAUSED){
        updatePlayIcons(false);
        setMediaSessionPlaybackState('paused');
      } else if (e.data === YT.PlayerState.ENDED){
        handleEnded();
      }
    }

    function playFromResults(i){
      const t = results[i];
      if (!t || !player) return;
      playContext = { type: 'results' };
      startTrack(t);
    }

    function playFromPlaylist(pid, idx){
      const p = getPlaylist(pid);
      if (!p) return;
      const t = p.songs[idx];
      if (!t || !player) return;
      playContext = { type: 'playlist', playlistId: pid };
      startTrack(t, idx);
    }

    function playDetailStart(shuffle){
      const p = getPlaylist(currentPlaylistId);
      if (!p || !p.songs.length) return showNotif("Playlist kosong.");
      playContext = { type: 'playlist', playlistId: p.id };
      if (shuffle){
        const r = Math.floor(Math.random() * p.songs.length);
        startTrack(p.songs[r], r);
      } else {
        startTrack(p.songs[0], 0);
      }
    }

    function startTrack(t, idxInPlaylist=null){
      nowTrack = t;
      document.getElementById('playerBar').classList.add('active');

      document.getElementById('pImg').src = t.thumb || '';
      setMarquee(t.title || 'Untitled');
      document.getElementById('pArtist').innerText = t.author || 'YouTube';
      document.getElementById('pDur').innerText = t.duration ? `• ${t.duration}` : '';
      document.getElementById('openYT').href = t.url || `https://www.youtube.com/watch?v=${t.id}`;

      document.getElementById('npImg').src = t.thumb || '';
      document.getElementById('npTitle').innerText = t.title || 'Untitled';
      document.getElementById('npArtist').innerText = t.author || 'YouTube';
      document.getElementById('npOpenYT').href = t.url || `https://www.youtube.com/watch?v=${t.id}`;

      const srcTxt = playContext.type === "playlist"
        ? `From playlist: ${(getPlaylist(playContext.playlistId)?.name || '-')}`
        : "From search results";
      document.getElementById("npSource").innerText = srcTxt;

      // loading
      document.getElementById('playBtn').innerHTML = '<i class="fas fa-circle-notch fa-spin text-lg"></i>';
      document.getElementById('npPlayIcon').className = 'fas fa-circle-notch fa-spin';

      // play
      player.loadVideoById(t.id);
      player.setVolume(Number(document.getElementById('vol').value));

      setMediaSessionMetadata(t);
      setMediaSessionPlaybackState('playing');

      // store current index for playlist navigation
      if (playContext.type === 'playlist' && idxInPlaylist !== null){
        // save index in context
        playContext.idx = idxInPlaylist;
      }

      syncModeIcons();
    }

    // marquee control
    function setMarquee(text){
      const wrap = document.getElementById('pTitleWrap');
      const main = document.getElementById('pTitle');
      const dup  = document.getElementById('pTitleDup');
      main.textContent = text || 'Pilih Lagu';
      dup.textContent = text || 'Pilih Lagu';
      requestAnimationFrame(() => {
        const needs = (wrap.scrollWidth > wrap.clientWidth + 40);
        wrap.classList.toggle('paused', !needs);
      });
    }

    // modes
    function toggleShuffle(){
      shuffleOn = !shuffleOn;
      localStorage.setItem(LS_MODES, JSON.stringify({ repeatMode, shuffleOn }));
      syncModeIcons();
      showNotif(shuffleOn ? "Shuffle: ON" : "Shuffle: OFF");
    }

    function cycleRepeatMode(){
      repeatMode = (repeatMode + 1) % 3;
      localStorage.setItem(LS_MODES, JSON.stringify({ repeatMode, shuffleOn }));
      syncModeIcons();
      showNotif(repeatMode===0 ? "Repeat: OFF" : repeatMode===1 ? "Repeat: ALL" : "Repeat: ONE");
    }

    function syncModeIcons(){
      const repClass = (repeatMode === 2) ? "fas fa-repeat-1" : "fas fa-repeat";
      ["miniRepIcon","npRepIcon","repIcon"].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.className = repClass;
        el.classList.toggle("text-green-500", repeatMode !== 0);
        el.classList.toggle("text-gray-400", repeatMode === 0);
      });

      ["miniShufIcon","shufIcon"].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle("text-green-500", shuffleOn);
        el.classList.toggle("text-gray-400", !shuffleOn);
      });
    }

    function handleEnded(){
      if (repeatMode === 2){
        player.playVideo();
        return;
      }

      if (playContext.type === 'playlist'){
        const p = getPlaylist(playContext.playlistId);
        if (!p || !p.songs.length) return;

        if (shuffleOn){
          const r = Math.floor(Math.random() * p.songs.length);
          startTrack(p.songs[r], r);
          return;
        }

        const cur = typeof playContext.idx === "number" ? playContext.idx : p.songs.findIndex(x=>x.id===nowTrack.id);
        const nxt = cur + 1;

        if (nxt < p.songs.length){
          startTrack(p.songs[nxt], nxt);
        } else {
          if (repeatMode === 1) startTrack(p.songs[0], 0);
          else updatePlayIcons(false);
        }
        return;
      }

      // results mode
      if (playContext.type === 'results' && results.length){
        if (shuffleOn){
          const r = Math.floor(Math.random() * results.length);
          startTrack(results[r], null);
          return;
        }
        const cur = results.findIndex(x=>x.id===nowTrack.id);
        const nxt = cur + 1;
        if (nxt < results.length) startTrack(results[nxt], null);
        else if (repeatMode === 1) startTrack(results[0], null);
      }
    }

    function next(){
      if (!nowTrack) return;
      handleEnded(); // same logic as ended (go next)
    }

    function prev(){
      if (!nowTrack) return;

      if (playContext.type === 'playlist'){
        const p = getPlaylist(playContext.playlistId);
        if (!p || !p.songs.length) return;

        if (shuffleOn){
          const r = Math.floor(Math.random() * p.songs.length);
          startTrack(p.songs[r], r);
          return;
        }

        const cur = typeof playContext.idx === "number" ? playContext.idx : p.songs.findIndex(x=>x.id===nowTrack.id);
        const prv = cur - 1;

        if (prv >= 0){
          startTrack(p.songs[prv], prv);
        } else {
          if (repeatMode === 1) startTrack(p.songs[p.songs.length-1], p.songs.length-1);
          else showNotif("Ini lagu pertama.");
        }
        return;
      }

      if (playContext.type === 'results' && results.length){
        if (shuffleOn){
          const r = Math.floor(Math.random() * results.length);
          startTrack(results[r], null);
          return;
        }
        const cur = results.findIndex(x=>x.id===nowTrack.id);
        const prv = cur - 1;
        if (prv >= 0) startTrack(results[prv], null);
        else if (repeatMode === 1) startTrack(results[results.length-1], null);
      }
    }

    function togglePlay(){
      if(!player) return;
      const st = player.getPlayerState();
      if (st === YT.PlayerState.PLAYING) player.pauseVideo();
      else player.playVideo();
    }

    function updatePlayIcons(isPlaying){
      document.getElementById('playBtn').innerHTML = isPlaying
        ? '<i class="fas fa-pause"></i>'
        : '<i class="fas fa-play ml-0.5"></i>';

      document.getElementById('npPlayIcon').className = isPlaying
        ? 'fas fa-pause'
        : 'fas fa-play ml-0.5';
    }

    // progress
    function startProgress(){
      stopProgress();
      progressTimer = setInterval(() => {
        if(!player) return;
        const dur = player.getDuration?.() || 0;
        const cur = player.getCurrentTime?.() || 0;

        document.getElementById('curT').innerText = fmt(cur);
        document.getElementById('durT').innerText = fmt(dur);
        document.getElementById('progressFill').style.width = (dur ? (cur/dur)*100 : 0) + '%';

        document.getElementById('npCur').innerText = fmt(cur);
        document.getElementById('npDur').innerText = fmt(dur);
        document.getElementById('npProgressFill').style.width = (dur ? (cur/dur)*100 : 0) + '%';
      }, 350);
    }
    function stopProgress(){
      if(progressTimer) clearInterval(progressTimer);
      progressTimer = null;
    }

    function seek(e){
      if(!player) return;
      const dur = player.getDuration?.() || 0;
      if(!dur) return;
      const rect = e.currentTarget.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      player.seekTo(Math.max(0, Math.min(dur, pct * dur)), true);
    }
    function npSeek(e){ seek(e); }

    function fmt(s){
      if(!s || !isFinite(s)) return "0:00";
      const m = Math.floor(s/60), sc = Math.floor(s%60);
      return `${m}:${sc < 10 ? '0' : ''}${sc}`;
    }

    // Now playing modal
    function openNowPlaying(){ if (!nowTrack) return; document.getElementById('npModal').classList.add('active'); }
    function closeNowPlaying(){ document.getElementById('npModal').classList.remove('active'); }

    // Media Session
    function setMediaSessionMetadata(track){
      if (!('mediaSession' in navigator) || !track) return;
      try{
        navigator.mediaSession.metadata = new MediaMetadata({
          title: track.title || 'RayPlayer',
          artist: track.author || 'YouTube',
          album: 'RayPlayer',
          artwork: [{ src: track.thumb || '', sizes: '512x512', type: 'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('play', () => player?.playVideo());
        navigator.mediaSession.setActionHandler('pause', () => player?.pauseVideo());
        navigator.mediaSession.setActionHandler('previoustrack', () => prev());
        navigator.mediaSession.setActionHandler('nexttrack', () => next());
        navigator.mediaSession.setActionHandler('seekto', (details) => {
          if (!player || !details || typeof details.seekTime !== 'number') return;
          player.seekTo(details.seekTime, true);
        });
      }catch(_){}
    }
    function setMediaSessionPlaybackState(state){
      if (!('mediaSession' in navigator)) return;
      try{ navigator.mediaSession.playbackState = state; }catch(_){}
    }

    // Add modal close
    function closeAddModal(){ document.getElementById("addModal").classList.remove("active"); }

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
      if (e.code === 'ArrowRight') next();
      if (e.code === 'ArrowLeft') prev();
      if (e.code === 'KeyR') cycleRepeatMode();
      if (e.code === 'KeyS') toggleShuffle();
      if (e.code === 'Escape'){ closeNowPlaying(); closeAddModal(); closePlModal(); }
    });

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') searchMusic();
    });

    // Boot
    // ensure at least 1 sample playlist? (optional) -> keep empty by default
  </script>
</body>
</html>
