<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ray Player • Ultra V12 (IFrame)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    :root { --sp-green:#1DB954; }
    body{ background:#000; color:#fff; font-family:'Plus Jakarta Sans',sans-serif; overflow:hidden; }

    #sidebar{ width:280px; transition:.25s; background:#000; border-right:1px solid #222; }
    #sidebar.hidden-mode{ width:0; padding:0; opacity:0; pointer-events:none; transform:translateX(-20px); }

    .search-input{ background:#242424!important; color:#fff!important; border:1px solid transparent; }
    .search-input::placeholder{ color:#888; }
    .search-input:focus{ background:#2a2a2a!important; border-color:#555; }

    #toast{
      position:fixed; top:18px; left:50%; transform:translate(-50%,-160%);
      background:var(--sp-green); color:#000; padding:12px 16px;
      border-radius:999px; font-weight:800; transition:.25s; z-index:9999;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      max-width:min(92vw,720px); text-align:center;
    }
    #toast.active{ transform:translate(-50%,0); }

    main{ padding-bottom:170px!important; }

    .music-card{
      background:#181818; border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:14px; cursor:pointer; transition:.2s;
    }
    .music-card:hover{ background:#242424; transform:translateY(-4px); }

    #playerBar{
      position:fixed; left:12px; right:12px; bottom:12px;
      height:110px; padding:12px 14px;
      background:rgba(18,18,18,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      box-shadow:0 24px 70px rgba(0,0,0,.55);
      display:none; align-items:center; gap:12px; z-index:1000;
    }
    #playerBar.active{ display:flex; }

    .song-info{ flex:1; min-width:0; display:flex; align-items:center; gap:12px; }
    .controls{ flex:2; min-width:0; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .rightzone{ flex:1; min-width:0; display:flex; justify-content:flex-end; align-items:center; gap:10px; }

    .icon-btn{ color:#9ca3af; transition:.15s; }
    .icon-btn:hover{ color:#fff; transform:translateY(-1px); }

    #playBtn{
      width:44px; height:44px; border-radius:999px;
      background:#fff; color:#000;
      display:flex; align-items:center; justify-content:center;
      transition:.15s; box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    #playBtn:hover{ transform:scale(1.08); }

    .progress-bg{
      width:100%; max-width:560px; height:6px;
      background:rgba(255,255,255,.12);
      border-radius:999px; overflow:hidden; cursor:pointer;
    }
    #progressFill{ height:100%; width:0%; background:var(--sp-green); border-radius:999px; }

    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      transition:.15s;
    }
    .pill:hover{ background: rgba(255,255,255,.10); }

    /* Hide the iframe visually (audio vibe), still plays audio */
    #ytWrap{
      position:fixed; width:1px; height:1px; left:-9999px; top:-9999px; overflow:hidden;
    }

    @media (max-width:768px){
      #sidebar{ position:absolute; height:100%; z-index:2000; }
      #playerBar{ left:10px; right:10px; bottom:10px; height:118px; padding:12px; }
      .rightzone{ display:none; }
      .controls{ flex:3; }
    }
  </style>
</head>

<body class="flex">
  <div id="toast">Ray Player siap.</div>

  <aside id="sidebar" class="flex flex-col h-screen p-5 shrink-0">
    <div class="flex items-center gap-3 mb-10 cursor-pointer" onclick="toggleSidebar()">
      <i class="fab fa-spotify text-3xl text-green-500"></i>
      <span class="text-xl font-extrabold tracking-tighter">RayPlayer</span>
    </div>

    <nav class="space-y-4">
      <div class="flex items-center gap-4 text-gray-400 hover:text-white transition font-bold cursor-pointer">
        <i class="fas fa-home text-xl"></i> Home
      </div>
      <div class="flex items-center gap-4 text-gray-400 hover:text-white transition font-bold cursor-pointer"
           onclick="document.getElementById('searchInput').focus()">
        <i class="fas fa-search text-xl"></i> Search
      </div>
    </nav>

    <div class="mt-10 overflow-hidden">
      <p class="text-[10px] font-bold text-gray-500 uppercase mb-4 tracking-widest">Queue</p>
      <div id="libList" class="space-y-2 overflow-y-auto max-h-[50vh] pr-1"></div>
    </div>
  </aside>

  <main class="flex-1 h-screen overflow-y-auto bg-gradient-to-b from-[#1e1e1e] to-black p-5 lg:p-10">
    <header class="flex items-center gap-4 mb-10">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-full transition">
        <i class="fas fa-bars"></i>
      </button>

      <div class="flex-1 max-w-xl relative">
        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Cari lagu apa hari ini?"
               class="search-input w-full py-3 pl-12 pr-4 rounded-full outline-none" />
      </div>

      <button onclick="searchMusic()" class="bg-white text-black px-6 py-3 rounded-full font-extrabold hover:scale-105 transition">
        Search
      </button>
    </header>

    <div class="flex items-end justify-between mb-6">
      <h2 class="text-2xl font-extrabold">Results</h2>
      <div id="hint" class="text-xs text-gray-400">Klik kartu buat play</div>
    </div>

    <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
  </main>

  <footer id="playerBar">
    <div class="song-info">
      <img id="pImg" src="" class="w-14 h-14 rounded-xl object-cover shadow-lg border border-white/5" />
      <div class="min-w-0">
        <div id="pTitle" class="text-sm font-extrabold truncate">Pilih Lagu</div>
        <div class="flex items-center gap-2 mt-1">
          <div id="pArtist" class="text-xs text-gray-400 truncate">YouTube</div>
          <span id="pDur" class="text-[10px] text-gray-500 font-mono"></span>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="flex items-center gap-6">
        <button onclick="prev()" class="icon-btn" title="Prev"><i class="fas fa-step-backward text-xl"></i></button>

        <button id="playBtn" onclick="togglePlay()" title="Play/Pause">
          <i class="fas fa-play ml-0.5"></i>
        </button>

        <button onclick="next()" class="icon-btn" title="Next"><i class="fas fa-step-forward text-xl"></i></button>

        <button onclick="toggleRepeat()" id="repBtn" class="icon-btn" title="Repeat">
          <i class="fas fa-redo"></i>
        </button>
      </div>

      <div class="flex items-center w-full gap-3">
        <span id="curT" class="text-[10px] text-gray-400 w-10 text-right font-mono">0:00</span>
        <div class="progress-bg flex-1" onclick="seek(event)">
          <div id="progressFill"></div>
        </div>
        <span id="durT" class="text-[10px] text-gray-400 w-10 font-mono">0:00</span>
      </div>
    </div>

    <div class="rightzone">
      <a id="openYT" class="pill text-xs text-gray-200" href="#" target="_blank" rel="noreferrer" title="Open on YouTube">
        <i class="fab fa-youtube text-red-500"></i><span>Open</span>
      </a>

      <div class="pill">
        <i class="fas fa-volume-up text-gray-300"></i>
        <input id="vol" type="range" min="0" max="100" step="1" value="100"
               class="w-24 accent-green-500 cursor-pointer" />
      </div>
    </div>
  </footer>

  <!-- Hidden YouTube player -->
  <div id="ytWrap"><div id="ytPlayer"></div></div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // App state
    let playlist = [];
    let currentIndex = -1;
    let isRepeat = false;

    // YT player
    let player = null;
    let progressTimer = null;

    function showNotif(msg){
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.add('active');
      setTimeout(() => t.classList.remove('active'), 2400);
    }

    function toggleSidebar(){
      document.getElementById('sidebar').classList.toggle('hidden-mode');
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // YouTube API callback
    function onYouTubeIframeAPIReady(){
      player = new YT.Player('ytPlayer', {
        height: '1',
        width: '1',
        videoId: '',
        playerVars: {
          autoplay: 0,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
        },
        events: {
          onReady: () => {
            showNotif("Player siap. Cari lagu dulu!");
            // volume bind
            document.getElementById('vol').addEventListener('input', (e) => {
              if (!player) return;
              player.setVolume(Number(e.target.value));
            });
          },
          onStateChange: onPlayerStateChange
        }
      });
    }

    function onPlayerStateChange(e){
      if (e.data === YT.PlayerState.PLAYING){
        updateBtn(true);
        startProgress();
      }
      if (e.data === YT.PlayerState.PAUSED){
        updateBtn(false);
      }
      if (e.data === YT.PlayerState.ENDED){
        if (isRepeat) player.playVideo();
        else next();
      }
    }

    async function searchMusic(){
      const q = document.getElementById('searchInput').value.trim();
      if(!q) return showNotif("Tulis judul lagu dulu!");

      const grid = document.getElementById('grid');
      grid.innerHTML = `<div class="col-span-full text-center py-20">
        <i class="fas fa-spinner fa-spin text-4xl text-green-500"></i>
      </div>`;

      try{
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        playlist = data;
        renderGrid();
        renderQueue();
      }catch(e){
        console.error(e);
        showNotif("Gagal mencari lagu.");
      }
    }

    function renderGrid(){
      const grid = document.getElementById('grid');
      if(!playlist.length){
        grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400">Tidak ada hasil.</div>`;
        return;
      }

      grid.innerHTML = playlist.map((t, i) => `
        <div class="music-card group" onclick="playSong(${i})">
          <div class="relative mb-3">
            <img src="${t.thumb}" class="w-full aspect-square object-cover rounded-xl shadow-lg">
            <div class="absolute inset-0 bg-black/45 opacity-0 group-hover:opacity-100 transition flex items-center justify-center rounded-xl">
              <div class="w-11 h-11 bg-green-500 rounded-full flex items-center justify-center shadow-xl">
                <i class="fas fa-play text-black"></i>
              </div>
            </div>
          </div>
          <div class="font-extrabold truncate text-sm">${escapeHtml(t.title)}</div>
          <div class="flex items-center justify-between gap-2 mt-1">
            <div class="text-xs text-gray-400 truncate">${escapeHtml(t.author)}</div>
            <div class="text-[10px] text-gray-500 font-mono">${escapeHtml(t.duration || "")}</div>
          </div>
        </div>
      `).join('');
    }

    function renderQueue(){
      const lib = document.getElementById('libList');
      if(!playlist.length){
        lib.innerHTML = `<div class="text-xs text-gray-500">Belum ada lagu.</div>`;
        return;
      }
      lib.innerHTML = playlist.map((t, i) => `
        <button onclick="playSong(${i})"
          class="w-full text-left px-3 py-2 rounded-xl transition border border-white/5
                 ${i===currentIndex ? 'bg-white/10' : 'hover:bg-white/5'}">
          <div class="text-xs font-extrabold truncate">${escapeHtml(t.title)}</div>
          <div class="text-[10px] text-gray-500 truncate mt-0.5">${escapeHtml(t.author)}</div>
        </button>
      `).join('');
    }

    function playSong(i){
      if(!player) return showNotif("Player belum siap, tunggu bentar…");

      currentIndex = i;
      const t = playlist[i];

      document.getElementById('pImg').src = t.thumb || '';
      document.getElementById('pTitle').innerText = t.title || 'Untitled';
      document.getElementById('pArtist').innerText = t.author || 'YouTube';
      document.getElementById('pDur').innerText = t.duration ? `• ${t.duration}` : '';
      document.getElementById('openYT').href = t.url || `https://www.youtube.com/watch?v=${t.id}`;
      document.getElementById('playerBar').classList.add('active');

      document.getElementById('playBtn').innerHTML = '<i class="fas fa-circle-notch fa-spin text-lg"></i>';
      renderQueue();

      // Load and play (official)
      player.loadVideoById(t.id);
      player.setVolume(Number(document.getElementById('vol').value));
      showNotif("Memutar: " + (t.title || "Video"));
    }

    function togglePlay(){
      if(!player) return;
      const st = player.getPlayerState();
      if (st === YT.PlayerState.PLAYING) player.pauseVideo();
      else player.playVideo();
    }

    function updateBtn(isPlaying){
      document.getElementById('playBtn').innerHTML = isPlaying
        ? '<i class="fas fa-pause"></i>'
        : '<i class="fas fa-play ml-0.5"></i>';
    }

    function toggleRepeat(){
      isRepeat = !isRepeat;
      document.getElementById('repBtn').classList.toggle('text-green-500', isRepeat);
      showNotif(isRepeat ? "Repeat: ON" : "Repeat: OFF");
    }

    function next(){
      if(currentIndex < playlist.length - 1) playSong(currentIndex + 1);
      else showNotif("Playlist habis.");
    }

    function prev(){
      if(currentIndex > 0) playSong(currentIndex - 1);
      else showNotif("Ini lagu pertama.");
    }

    function startProgress(){
      stopProgress();
      progressTimer = setInterval(() => {
        if(!player) return;
        const dur = player.getDuration?.() || 0;
        const cur = player.getCurrentTime?.() || 0;

        document.getElementById('curT').innerText = fmt(cur);
        document.getElementById('durT').innerText = fmt(dur);

        const pct = dur ? (cur / dur) * 100 : 0;
        document.getElementById('progressFill').style.width = pct + '%';
      }, 350);
    }

    function stopProgress(){
      if(progressTimer) clearInterval(progressTimer);
      progressTimer = null;
    }

    function seek(e){
      if(!player) return;
      const dur = player.getDuration?.() || 0;
      if(!dur) return;

      const rect = e.currentTarget.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      player.seekTo(Math.max(0, Math.min(dur, pct * dur)), true);
    }

    function fmt(s){
      if(!s || !isFinite(s)) return "0:00";
      const m = Math.floor(s/60), sc = Math.floor(s%60);
      return `${m}:${sc < 10 ? '0' : ''}${sc}`;
    }

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') searchMusic();
    });
  </script>
</body>
</html>
